<div class="container mt-4">
    <h3>Pattern Drawer</h3>
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Word to Pattern</label>
                <input type="text" id="pattern-word" 
                       class="form-control text-uppercase" 
                       maxlength="5" 
                       placeholder="APPLE"
                       oninput="this.value = this.value.toUpperCase()">
            </div>

            <!-- 5x6 Grid -->
            <div id="grid" class="d-flex flex-column gap-2 mb-3">
                <!-- Rows will be generated by JS -->
            </div>

            <div class="d-grid gap-2 d-md-block">
                <button class="btn btn-primary" onclick="submitPattern()">Get Words</button>
                <button class="btn btn-secondary" onclick="resetGrid()">Reset</button>
            </div>
        </div>

        <div class="col-md-6">
            <label class="form-label d-flex align-items-center gap-2">
                Possible Words <span id="word-status"></span>
            </label>
            <div id="draw-results" class="border p-3 bg-light" style="min-height: 400px;">
                <p class="text-muted">Submit a pattern to see matching words.</p>
            </div>
        </div>
    </div>
</div>

<style>
    .grid-box {
        width: 50px;
        height: 50px;
        border: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        user-select: none;
        font-weight: bold;
        color: white;
        text-transform: uppercase;
    }
    .bg-grey { background-color: #6c757d; }
    .bg-yellow { background-color: #ffc107; }
    .bg-green { background-color: #198754; }
</style>

<script>
    const ROWS = 6;
    const COLS = 5;
    const COLORS = ['grey', 'yellow', 'green'];

    function createGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        for (let r = 0; r < ROWS; r++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'd-flex gap-2';
            for (let c = 0; c < COLS; c++) {
                const box = document.createElement('div');
                box.className = 'grid-box bg-grey';
                box.dataset.color = 'grey';
                box.dataset.row = r;
                box.dataset.col = c;
                box.onclick = () => cycleColor(box);
                rowDiv.appendChild(box);
            }
            grid.appendChild(rowDiv);
        }
    }

    function cycleColor(box) {
        const currentColor = box.dataset.color;
        let nextIndex = (COLORS.indexOf(currentColor) + 1) % COLORS.length;
        const nextColor = COLORS[nextIndex];

        box.classList.remove('bg-grey', 'bg-yellow', 'bg-green');
        box.classList.add(`bg-${nextColor}`);
        box.dataset.color = nextColor;
    }

    function resetGrid() {
        document.getElementById('pattern-word').value = '';
        document.getElementById('draw-results').innerHTML = '<p class="text-muted">Submit a pattern to see matching words.</p>';
        createGrid();
    }

    async function submitPattern() {
        const word = document.getElementById('pattern-word').value.toUpperCase();
        if (word.length !== 5) {
            alert("Please enter a 5-letter word.");
            return;
        }

        const rowsData = [];
        for (let r = 0; r < ROWS; r++) {
            const rowColors = [];
            const boxes = document.querySelectorAll(`.grid-box[data-row="${r}"]`);
            boxes.forEach(box => rowColors.push(box.dataset.color));

            // Only add rows that have been modified or treat all 6 rows?
            // The API expects PatternRows. Usually we send rows that are "active".
            rowsData.push({ patternRow: rowColors, patternWords: [] });
        }

        const payload = {
            patternWord: word,
            patternRows: rowsData
        };

        const response = await fetch('/api/draw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        renderResults(result.patternRows);
    }

    function renderResults(patternRows) {
        const resultsDiv = document.getElementById('draw-results');
        const statusSpan = document.getElementById('word-status');
        resultsDiv.innerHTML = '';

        let rowsWithWords = 0;
        patternRows.forEach((row, index) => {
            if (row.patternWords && row.patternWords.length > 0) {
                rowsWithWords++;
                const section = document.createElement('div');
                section.className = 'mb-3 pb-2 border-bottom';
                section.innerHTML = `
                    <h6 class="text-dark fw-bold">Row ${index + 1} Words To Try:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        ${row.patternWords.map(w => `<span class="badge bg-dark">${w}</span>`).join('')}
                    </div>
                `;
                resultsDiv.appendChild(section);
            }
        });

        // Update status indicator
        if (rowsWithWords === 6) {
            statusSpan.innerHTML = '<span class="text-success">✅ All Rows Found</span>';
        } else {
            statusSpan.innerHTML = '<span class="text-danger">❌ Incomplete Rows</span>';
        }

        if (resultsDiv.innerHTML === '') {
            resultsDiv.innerHTML = '<p class="text-muted">No words found for the selected patterns.</p>';
        }
    }

    // Initialize grid on load
    createGrid();
</script>