<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6 text-center">
            <h3>Twortle Game</h3>
            <div class="d-flex justify-content-center gap-2 mb-4">
                <select id="lengthSelect" class="form-select" style="width: auto;">
                    <option value="" disabled selected>Select Length</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
                <button id="startGameBtn" class="btn btn-primary">Start New Game</button>
            </div>

            <div id="gameBoard" class="mb-4"></div>

            <div id="inputArea" style="display: none;">
                <div class="input-group mb-2">
                    <input type="text" id="guessInput" class="form-control text-center fs-4" 
                           style="text-transform: uppercase;" autocomplete="off">
                    <button class="btn btn-success" type="button" id="checkGuessBtn">Check</button>
                </div>
                <p class="text-muted">Enter your guess and click Check or press Enter</p>
            </div>
            
            <div id="messageArea" class="mt-3 fw-bold"></div>
        </div>
    </div>
</div>

<style>
    .grid-row {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-bottom: 5px;
    }
    .grid-square {
        width: 50px;
        height: 50px;
        border: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        text-transform: uppercase;
        color: white;
        background-color: transparent;
        transition: background-color 0.3s, border-color 0.3s;
    }
    [data-bs-theme="light"] .grid-square { color: black; }
    [data-bs-theme="dark"] .grid-square { color: white; }

    .square-grey { background-color: #6c757d !important; border-color: #6c757d !important; color: white !important; }
    .square-yellow { background-color: #ffc107 !important; border-color: #ffc107 !important; color: black !important; }
    .square-green { background-color: #198754 !important; border-color: #198754 !important; color: white !important; }
</style>

<script>
    let currentWord = null;
    let wordLength = 0;
    let currentRow = 0;
    let maxRows = 0;

    document.getElementById('startGameBtn').addEventListener('click', () => {
        const length = document.getElementById('lengthSelect').value;
        if (!length) return;

        fetch('/api/play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ length: parseInt(length) })
        })
            .then(res => res.json())
            .then(wordObj => {
                currentWord = wordObj;
                wordLength = length;
                maxRows = parseInt(length) + 1;
                currentRow = 0;
                initBoard();
            });
    });

    function initBoard() {
        const board = document.getElementById('gameBoard');
        board.innerHTML = '';
        for (let r = 0; r < maxRows; r++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'grid-row';
            for (let c = 0; c < wordLength; c++) {
                const square = document.createElement('div');
                square.className = 'grid-square';
                square.id = `cell-${r}-${c}`;
                rowDiv.appendChild(square);
            }
            board.appendChild(rowDiv);
        }

        const inputArea = document.getElementById('inputArea');
        inputArea.style.display = 'block';
        const input = document.getElementById('guessInput');
        input.maxLength = wordLength;
        input.value = '';
        input.focus();
        document.getElementById('messageArea').textContent = '';
    }

    function submitGuess() {
        const input = document.getElementById('guessInput');
        const guess = input.value;
        if (guess.length !== parseInt(wordLength)) return;

        fetch('/api/check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ word: currentWord, guess: guess })
        })
        .then(res => res.json())
        .then(data => {
            const colors = data.pattern.colors;
            for (let i = 0; i < colors.length; i++) {
                const cell = document.getElementById(`cell-${currentRow}-${i}`);
                cell.classList.add(`square-${colors[i]}`);
            }

            if (data.isAllMatch) {
                document.getElementById('messageArea').textContent = "You Won! ðŸŽ‰";
                document.getElementById('inputArea').style.display = 'none';
            } else {
                currentRow++;
                input.value = '';
                if (currentRow >= maxRows) {
                    document.getElementById('messageArea').textContent = `Game Over! The word was: ${currentWord.WordText}`;
                    document.getElementById('inputArea').style.display = 'none';
                }
            }
        });
    }

    document.getElementById('checkGuessBtn').addEventListener('click', submitGuess);

    document.getElementById('guessInput').addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^a-zA-Z]/g, '').toUpperCase();
        // Update current row visuals as they type
        const val = e.target.value;
        for (let i = 0; i < wordLength; i++) {
            const cell = document.getElementById(`cell-${currentRow}-${i}`);
            cell.textContent = val[i] || '';
        }
    });

    document.getElementById('guessInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            submitGuess();
        }
    });
</script>